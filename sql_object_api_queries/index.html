<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
  <title>JDBI : SQL Object Queries</title>
  <script language="JavaScript" type="text/javascript">
    if (top.location != self.location) top.location.replace(self.location);
  </script>
  <link href='http://fonts.googleapis.com/css?family=Cardo' rel='stylesheet' type='text/css' />
  <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css' />
  
  <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
  <link rel="stylesheet" href="/css/screen.css" type="text/css" />
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23947671-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  </script>
</head>
<body>
  <div id="site">
    <div id="header">
      <h1>
	<a href="/">JDBI</a>
        <span id="navigation">
          <a href="/archive.html">Docs</a> |
          <a href="http://github.com/brianm/jdbi/">Source</a> |
          <a href="/getting_jdbi/">Download</a> |
          <a href="/maven_site/apidocs">Javadoc</a>
        </span>
      </h1>
    </div>
    <div id="content">
      <div id="page">
    <h1 class="emphnext">
      	<a href="">SQL Object Queries</a> 
    </h1>
<p>Queries are denoted on sql object interfaces via the <code>@SqlQuery</code> annotation on the query methods. The return type of the method indicates what to do with the result set. Take the following queries:</p>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>interface</span> <span class='nc'>SomeQueries</span>
<span class='o'>{</span>
  <span class='nd'>@SqlQuery</span><span class='o'>(</span><span class='s'>&quot;select name from something where id = :id&quot;</span><span class='o'>)</span>
  <span class='n'>String</span> <span class='nf'>findName</span><span class='o'>(</span><span class='nd'>@Bind</span><span class='o'>(</span><span class='s'>&quot;id&quot;</span><span class='o'>)</span> <span class='kt'>int</span> <span class='n'>id</span><span class='o'>);</span>

  <span class='nd'>@SqlQuery</span><span class='o'>(</span><span class='s'>&quot;select name from something where id &gt; :from and id &lt; :to&quot;</span><span class='o'>)</span>
  <span class='n'>List</span><span class='o'>&lt;</span><span class='n'>String</span><span class='o'>&gt;</span> <span class='n'>findNamesBetween</span><span class='o'>(</span><span class='nd'>@Bind</span><span class='o'>(</span><span class='s'>&quot;from&quot;</span><span class='o'>)</span> <span class='kt'>int</span> <span class='n'>from</span><span class='o'>,</span> <span class='nd'>@Bind</span><span class='o'>(</span><span class='s'>&quot;to&quot;</span><span class='o'>)</span> <span class='kt'>int</span> <span class='n'>to</span><span class='o'>);</span>

  <span class='nd'>@SqlQuery</span><span class='o'>(</span><span class='s'>&quot;select name from something&quot;</span><span class='o'>)</span>
  <span class='n'>Iterator</span><span class='o'>&lt;</span><span class='n'>String</span><span class='o'>&gt;</span> <span class='n'>findAllNames</span><span class='o'>();</span>
  
  <span class='nd'>@SqlQuery</span><span class='o'>(</span><span class='s'>&quot;select name from something where id = :id&quot;</span><span class='o'>)</span>
  <span class='n'>Query</span><span class='o'>&lt;</span><span class='n'>String</span><span class='o'>&gt;</span> <span class='n'>queryById</span><span class='o'>(</span><span class='nd'>@Bind</span><span class='o'>(</span><span class='s'>&quot;id&quot;</span><span class='o'>)</span> <span class='kt'>int</span> <span class='n'>id</span><span class='o'>);</span>

<span class='o'>}</span>
</code></pre>
</div>
<p>The first method, <code>findName</code> infers that you want only the first result, and it will be mapped into a <code>String</code>. It will take the first element in the first row of the result set to return.</p>

<p>The second method, <code>findNamesBetween</code> will again infer that we are looking for a String, and pull the first string from each row of the result set. Because it returns a <code>java.util.List</code> it will eagerly map each row to a String and return the full result set.</p>

<p>The third method, <code>findAllNames</code> does the same String extraction from each row, but because the method returns a <code>java.util.Iterator</code> it loads results lazily, only traversing the result set as <code>Iterator#next</code> or <code>Iterator#hasNext</code> is called. The iterator returned is actually a <a href='/maven_site/apidocs/org/skife/jdbi/v2/ResultIterator.html'>ResultIterator</a>. The underlying result set will be closed when the <code>ResultIterator#close</code> method is invoked, or when the end of the result set is reached.</p>

<p>The final method, <code>queryById</code> returns a <a href='/maven_site/apidocs/org/skife/jdbi/v2/Query.html'>Query</a> instance mapped to a string. This form binds what it knows about, applies customizers, and returns the <a href='/fluent_queries/'>fluent-api query</a> instance which has not yet been executed.</p>

<p>As with String, mappings for singular primitive types in the first position of the result set are provided out of the box by JDBI. For more sophisticated mappings you can register <a href='/maven_site/apidocs/org/skife/jdbi/v2/tweak/ResultSetMapper.html'>ResultSetMapper</a> or <a href='/maven_site/apidocs/org/skife/jdbi/v2/ResultSetMapperFactory.html'>ResultSetMapperFactory</a> instances with either the DBI, the Handle, or on the sql object or individual method. Take for example the following result set mapper and class it maps to:</p>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>Something</span>
<span class='o'>{</span>
  <span class='kd'>private</span> <span class='kt'>int</span> <span class='n'>id</span><span class='o'>;</span>
  <span class='kd'>private</span> <span class='n'>String</span> <span class='n'>name</span><span class='o'>;</span>
  
  <span class='kd'>public</span> <span class='nf'>Something</span><span class='o'>()</span> <span class='o'>{</span> <span class='o'>}</span>

  <span class='kd'>public</span> <span class='nf'>Something</span><span class='o'>(</span><span class='kt'>int</span> <span class='n'>id</span><span class='o'>,</span> <span class='n'>String</span> <span class='n'>name</span><span class='o'>)</span>
  <span class='o'>{</span>
    <span class='k'>this</span><span class='o'>.</span><span class='na'>id</span> <span class='o'>=</span> <span class='n'>id</span><span class='o'>;</span>
    <span class='k'>this</span><span class='o'>.</span><span class='na'>name</span> <span class='o'>=</span> <span class='n'>name</span><span class='o'>;</span>
  <span class='o'>}</span>

  <span class='kd'>public</span> <span class='kt'>int</span> <span class='nf'>getId</span><span class='o'>()</span>
  <span class='o'>{</span>
    <span class='k'>return</span> <span class='n'>id</span><span class='o'>;</span>
  <span class='o'>}</span>

  <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>setId</span><span class='o'>(</span><span class='kt'>int</span> <span class='n'>id</span><span class='o'>)</span>
  <span class='o'>{</span>
    <span class='k'>this</span><span class='o'>.</span><span class='na'>id</span> <span class='o'>=</span> <span class='n'>id</span><span class='o'>;</span>
  <span class='o'>}</span>

  <span class='kd'>public</span> <span class='n'>String</span> <span class='nf'>getName</span><span class='o'>()</span>
  <span class='o'>{</span>
    <span class='k'>return</span> <span class='n'>name</span><span class='o'>;</span>
  <span class='o'>}</span>

  <span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>setName</span><span class='o'>(</span><span class='n'>String</span> <span class='n'>name</span><span class='o'>)</span>
  <span class='o'>{</span>
    <span class='k'>this</span><span class='o'>.</span><span class='na'>name</span> <span class='o'>=</span> <span class='n'>name</span><span class='o'>;</span>
  <span class='o'>}</span>
<span class='o'>}</span>

<span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>SomethingMapper</span> <span class='kd'>implements</span> <span class='n'>ResultSetMapper</span><span class='o'>&lt;</span><span class='n'>Something</span><span class='o'>&gt;</span>
<span class='o'>{</span>
  <span class='kd'>public</span> <span class='n'>Something</span> <span class='nf'>map</span><span class='o'>(</span><span class='kt'>int</span> <span class='n'>index</span><span class='o'>,</span> <span class='n'>ResultSet</span> <span class='n'>r</span><span class='o'>,</span> <span class='n'>StatementContext</span> <span class='n'>ctx</span><span class='o'>)</span> <span class='kd'>throws</span> <span class='n'>SQLException</span>
  <span class='o'>{</span>
    <span class='k'>return</span> <span class='k'>new</span> <span class='nf'>Something</span><span class='o'>(</span><span class='n'>r</span><span class='o'>.</span><span class='na'>getInt</span><span class='o'>(</span><span class='s'>&quot;id&quot;</span><span class='o'>),</span> <span class='n'>r</span><span class='o'>.</span><span class='na'>getString</span><span class='o'>(</span><span class='s'>&quot;name&quot;</span><span class='o'>));</span>
  <span class='o'>}</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>We can now make use of the <code>SomethingMapper</code> in a couple ways. The first is to register it on the sql object itself:</p>

<p><div class='highlight'><pre><code class='java'><span class='nd'>@RegisterMapper</span><span class='o'>(</span><span class='n'>SomethingMapper</span><span class='o'>.</span><span class='na'>class</span><span class='o'>)</span>
<span class='kd'>public</span> <span class='kd'>interface</span> <span class='nc'>AnotherQuery</span>
<span class='o'>{</span>
  <span class='nd'>@SqlQuery</span><span class='o'>(</span><span class='s'>&quot;select id, name from something where id = :id&quot;</span><span class='o'>)</span>
  <span class='n'>Something</span> <span class='nf'>findById</span><span class='o'>(</span><span class='nd'>@Bind</span><span class='o'>(</span><span class='s'>&quot;id&quot;</span><span class='o'>)</span> <span class='kt'>int</span> <span class='n'>id</span><span class='o'>);</span>
<span class='o'>}</span>
</code></pre>
</div></p>

<p>In this case whenever a query needs to map to <code>Something</code> it will find the registered mapper and try to use that.</p>

<p>Alternately, we can specify a result mapper to use for a specific method:</p>
<div class='highlight'><pre><code class='java'><span class='kd'>public</span> <span class='kd'>interface</span> <span class='nc'>YetAnotherQuery</span>
<span class='o'>{</span>
  <span class='nd'>@SqlQuery</span><span class='o'>(</span><span class='s'>&quot;select id, name from something where id = :id&quot;</span><span class='o'>)</span>
  <span class='nd'>@Mapper</span><span class='o'>(</span><span class='n'>SomethingMapper</span><span class='o'>.</span><span class='na'>class</span><span class='o'>)</span>
  <span class='n'>Something</span> <span class='nf'>findById</span><span class='o'>(</span><span class='nd'>@Bind</span><span class='o'>(</span><span class='s'>&quot;id&quot;</span><span class='o'>)</span> <span class='kt'>int</span> <span class='n'>id</span><span class='o'>);</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>You can also register result set mappers on the <code>DBI</code> or <code>Handle</code> instance the sql object is attached to.</p>
    <div id="pagination">
        
            <a href="/sql_object_overview" class="back">❮❮ SQL Object API Overview </a>
        
        
        <a href="/">Home</a> | <a href="/archive.html">Docs</a>
        
        
            <a href="/sql_object_api_dml" class="forward"> SQL Object Data Manipulation ❯❯</a>
        
    </div>
</div>


    </div>
    <div id="footer">
      &copy; 2011 Brian McCallister
    </div>
  </div>
</body>
</html>

